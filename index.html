<!DOCTYPE html>
<html lang="en">

<head>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/svg.js/3.1.2/svg.min.js"
        integrity="sha512-I+rKw3hArzZIHzrkdELbKqrXfkSvw/h0lW/GgB8FThaBVz2e5ZUlSW8kY8v3q6wq37eybIwyufkEZxe4qSlGcg=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p"
        crossorigin="anonymous"></script>

    <link href="dist/css/bootstrap-colorpicker.css" rel="stylesheet">
    <script src="dist/js/bootstrap-colorpicker.js"></script>
    <link href="NodeStyle.css" rel="stylesheet">

    <meta charset="UTF-8">
    <title>Title</title>
</head>

<body>
    <button type="button" style="position: absolute; right: 25px; top: 25px;" class="btn btn-outline-success"
        data-bs-toggle="modal" data-bs-target="#NodeCreator">Create new Node</button>

    <div class="modal fade" id="NodeCreator" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true"
        data-bs-theme="dark">
        <div class="modal-dialog">
            <div class="modal-content node">
                <div class="modal-header" style="border: none;">
                    <h1 class="modal-title fs-5" id="exampleModalLabel">Create Node</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">



                    <form>
                        <div class="mb-3">
                            <label for="NNodeName" class="form-label">Node Name</label>
                            <input type="email" class="form-control" id="NNodeName" aria-describedby="emailHelp">

                        </div>
                        <div id="io">

                        </div>
                        <button type="button" id="addio" style="width: 100%;" class="btn btn-outline-success">Add
                            IO</button>

                    </form>


                </div>
                <div class="modal-footer" style="border: none;">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" id="NodeSave" class="btn btn-success">Save changes</button>
                </div>
            </div>
        </div>
    </div>

    <div id="a">
        <div id='rightmenu' style='position:absolute; z-index: 10; visibility:hidden; left:0px; top:0px'>
            <ul class='list-group'> <a href='#'
                    class='list-group-item list-group-item-action list-group-item-danger'>Remove
                    Connection</a></ul>
        </div>


        <svg id="svg" style="z-index: 5;" width="1000" height="1000"></svg>
        <div id="Nodes"></div>

        <div class="offcanvas offcanvas-bottom" tabindex="-1" id="addMenu" aria-labelledby="offcanvasBottomLabel">
            <div class="offcanvas-header">
                <h5 class="offcanvas-title" id="offcanvasBottomLabel">Add Nodes</h5>
                <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
            </div>
            <div class="offcanvas-body small">

                <div id="add" class="btn-group" role="group" style="margin-top:1.5%; width:100%"></div>
            </div>
        </div>



        <svg version="1.0" x="0px" y="0px" xmlns="http://www.w3.org/2000/svg"
            style="position: absolute;bottom:2%; left:50%; " width="64px" height="64px" viewBox="0 0 1145 1147"
            id="buttonAdd" data-bs-toggle="offcanvas" data-bs-target="#addMenu" aria-controls="offcanvasBottom">
            <polygon class="a0" stroke="#198753" stroke-opacity="1" fill="none" stroke-linecap="round"
                stroke-width="18.75"
                points="401.3564467430115,1029.3268203735352 325.0000476837158,1029.3268203735352 277.6744842529297,1029.3268203735352 257.85388946533203,1027.8618812561035 238.4204387664795,1023.6973762512207 219.7010040283203,1017.0201778411865 201.9908905029297,1008.0005168914795 185.55996417999268,996.8189716339111 170.65610885620117,983.670711517334 157.50784873962402,968.7668561935425 146.32630348205566,952.3359298706055 137.30664253234863,934.6258163452148 130.62944412231445,915.9063816070557 126.46493911743164,896.4729309082031 125.0,876.6523361206055 125.0,829.3266296386719 125.0,753.5580277442932 126.21574401855469,745.8817839622498 129.7441005706787,738.9569640159607 135.23969650268555,733.4613919258118 142.1645164489746,729.9330115318298 149.84078407287598,728.7172317504883 150.15945434570312,728.7172317504883 157.83562660217285,729.9330115318298 164.7604465484619,733.4613919258118 170.25604248046875,738.9569640159607 173.78439903259277,745.8817839622498 175.0002384185791,753.5580277442932 175.0002384185791,866.1900997161865 176.08580589294434,880.8778524398804 179.17184829711914,895.2787160873413 184.11986827850342,909.1504573822021 190.80374240875244,922.2742795944214 199.0896463394165,934.4501495361328 208.8329553604126,945.4944372177124 219.8772430419922,955.2377700805664 232.05313682556152,963.5236740112305 245.17693519592285,970.2075481414795 259.0486764907837,975.1555919647217 273.44954013824463,978.2416343688965 288.1372928619385,979.3272018432617 401.3564467430115,979.3272495269775 409.03269052505493,980.5429935455322 415.957510471344,984.0713500976562 421.4530825614929,989.5669460296631 424.98146295547485,996.4917659759521 426.1972427368164,1004.1680335998535 426.1972427368164,1004.4860363006592 424.98146295547485,1012.1622085571289 421.4530825614929,1019.087028503418 415.957510471344,1024.5826244354248 409.03269052505493,1028.1109809875488 401.3564467430115,1029.3268203735352 ">
            </polygon>
            <polygon class="a1" stroke="#198753" stroke-opacity="1" fill="none" stroke-linecap="round"
                stroke-width="18.75"
                points="1027.9664516448975,753.1173825263977 1027.9664516448975,829.4737815856934 1027.9664516448975,876.7993450164795 1026.5015125274658,896.6199398040771 1022.337007522583,916.0533905029297 1015.6598091125488,934.7728252410889 1006.6401481628418,952.4829387664795 995.4586029052734,968.9138650894165 982.3103427886963,983.817720413208 967.4064874649048,996.9659805297852 950.9755611419678,1008.1475257873535 933.2654476165771,1017.1671867370605 914.546012878418,1023.8443851470947 895.1125621795654,1028.0088901519775 875.2919673919678,1029.4738292694092 827.9662609100342,1029.4738292694092 752.1976590156555,1029.4738292694092 744.5214152336121,1028.2580852508545 737.596595287323,1024.7297286987305 732.1010231971741,1019.2341327667236 728.5726428031921,1012.3093128204346 727.3568630218506,1004.6330451965332 727.3568630218506,1004.314374923706 728.5726428031921,996.6382026672363 732.1010231971741,989.7133827209473 737.596595287323,984.2177867889404 744.5214152336121,980.6894302368164 752.1976590156555,979.4735908508301 864.8297309875488,979.4735908508301 879.5174837112427,978.3880233764648 893.9183473587036,975.30198097229 907.7900886535645,970.3539609909058 920.9139108657837,963.6700868606567 933.0897808074951,955.3841829299927 944.1340684890747,945.6408739089966 953.8774013519287,934.596586227417 962.1633052825928,922.4206924438477 968.8471794128418,909.2968940734863 973.795223236084,895.4251527786255 976.8812656402588,881.0242891311646 977.966833114624,866.3365364074707 977.9668807983398,753.1173825263977 979.1826248168945,745.4411387443542 982.7109813690186,738.5163187980652 988.2065773010254,733.0207467079163 995.1313972473145,729.4923663139343 1002.8076648712158,728.2765865325928 1003.1256675720215,728.2765865325928 1010.8018398284912,729.4923663139343 1017.7266597747803,733.0207467079163 1023.2222557067871,738.5163187980652 1026.7506122589111,745.4411387443542 1027.9664516448975,753.1173825263977 ">
            </polygon>
            <polygon class="a2" stroke="#198753" stroke-opacity="1" fill="none" stroke-linecap="round"
                stroke-width="18.75"
                points="542.310157418251,305.22522926330566 543.5259521007538,297.5489616394043 547.0543295145035,290.62414169311523 552.5499030947685,285.1285696029663 559.4747304916382,281.6001892089844 567.1509578824043,280.3844213485718 585.4693576693535,280.3844213485718 593.1455850601196,281.6001892089844 600.0704124569893,285.1285696029663 605.5659860372543,290.62414169311523 609.094363451004,297.5489616394043 610.3101581335068,305.22522926330566 610.3101581335068,513.3772671222687 611.1448407173157,520.1244533061981 613.4868413209915,526.5069365501404 617.1582698822021,532.2289764881134 621.965616941452,537.0363235473633 627.687656879425,540.7077521085739 634.0701401233673,543.0497527122498 640.8173263072968,543.8844352960587 848.9693641662598,543.8844352960587 856.6456317901611,545.1002299785614 863.5704517364502,548.6286073923111 869.0660238265991,554.1241809725761 872.594404220581,561.0490083694458 873.8101720809937,568.725235760212 873.8101720809937,587.0436355471611 872.594404220581,594.7198629379272 869.0660238265991,601.6446903347969 863.5704517364502,607.140263915062 856.6456317901611,610.6686413288116 848.9693641662598,611.8844360113144 640.8173263072968,611.8844360113144 634.0701401233673,612.7191185951233 627.687656879425,615.0611191987991 621.965616941452,618.7325477600098 617.1582698822021,623.5398948192596 613.4868413209915,629.2619347572327 611.1448407173157,635.6444180011749 610.3101581335068,642.3916041851044 610.3101581335068,850.5436420440674 609.094363451004,858.2199096679688 605.5659860372543,865.1447296142578 600.0704124569893,870.6403017044067 593.1455850601196,874.1686820983887 585.4693576693535,875.3844499588013 567.1509578824043,875.3844499588013 559.4747304916382,874.1686820983887 552.5499030947685,870.6403017044067 547.0543295145035,865.1447296142578 543.5259521007538,858.2199096679688 542.310157418251,850.5436420440674 542.310157418251,642.3916041851044 541.4754748344421,635.6444180011749 539.1334742307663,629.2619347572327 535.4620456695557,623.5398948192596 530.6546986103058,618.7325477600098 524.9326586723328,615.0611191987991 518.5501754283905,612.7191185951233 511.80298924446106,611.8844360113144 303.65095138549805,611.8844360113144 295.9746837615967,610.6686413288116 289.0498638153076,607.140263915062 283.5542917251587,601.6446903347969 280.02591133117676,594.7198629379272 278.81014347076416,587.0436355471611 278.81014347076416,568.725235760212 280.02591133117676,561.0490083694458 283.5542917251587,554.1241809725761 289.0498638153076,548.6286073923111 295.9746837615967,545.1002299785614 303.65095138549805,543.8844352960587 511.80298924446106,543.8844352960587 518.5501754283905,543.0497527122498 524.9326586723328,540.7077521085739 530.6546986103058,537.0363235473633 535.4620456695557,532.2289764881134 539.1334742307663,526.5069365501404 541.4754748344421,520.1244533061981 542.310157418251,513.3772671222687 542.310157418251,305.22522926330566 ">
            </polygon>
            <polygon class="a3" stroke="#198753" stroke-opacity="1" fill="none" stroke-linecap="round"
                stroke-width="18.75"
                points="751.5302300453186,125.14700889587402 827.8866291046143,125.14700889587402 875.2121925354004,125.14700889587402 895.032787322998,126.61194801330566 914.4662380218506,130.77645301818848 933.1856727600098,137.45365142822266 950.8957862854004,146.4733123779297 967.3267126083374,157.65485763549805 982.2305679321289,170.8031177520752 995.378828048706,185.7069730758667 1006.5603733062744,202.1378993988037 1015.5800342559814,219.84801292419434 1022.2572326660156,238.56744766235352 1026.4217376708984,258.00089836120605 1027.88667678833,277.8214931488037 1027.88667678833,325.1471996307373 1027.88667678833,400.9158253669739 1026.6709327697754,408.59206914901733 1023.1425762176514,415.5168890953064 1017.6469802856445,421.0124611854553 1010.7221603393555,424.54084157943726 1003.0458927154541,425.7566213607788 1002.7272701263428,425.7566213607788 995.0510025024414,424.54084157943726 988.1261825561523,421.0124611854553 982.6305866241455,415.5168890953064 979.1022300720215,408.59206914901733 977.8864860534668,400.9158253669739 977.8864860534668,288.28372955322266 976.8009185791016,273.5959768295288 973.7148761749268,259.19511318206787 968.7668323516846,245.32337188720703 962.0829582214355,232.1995496749878 953.7970542907715,220.02367973327637 944.0537214279175,208.97939205169678 933.0094337463379,199.23605918884277 920.8335638046265,190.9501552581787 907.7097415924072,184.2662811279297 893.8380002975464,179.3182373046875 879.4371366500854,176.2321949005127 864.7493839263916,175.14662742614746 751.5302300453186,175.14662742614746 743.8539862632751,173.93088340759277 736.9291663169861,170.40252685546875 731.4335942268372,164.9069309234619 727.9052138328552,157.98211097717285 726.6894340515137,150.30584335327148 726.6894340515137,149.98779296875 727.9052138328552,142.31152534484863 731.4335942268372,135.38670539855957 736.9291663169861,129.89110946655273 743.8539862632751,126.36275291442871 751.5302300453186,125.14700889587402 ">
            </polygon>
            <polygon class="a4" stroke="#198753" stroke-opacity="1" fill="none" stroke-linecap="round"
                stroke-width="18.75"
                points="125.14710426330566,401.35645866394043 125.14710426330566,325.00007152557373 125.14710426330566,277.6744842529297 126.6120433807373,257.85388946533203 130.77654838562012,238.4204387664795 137.4537467956543,219.7010040283203 146.47340774536133,201.9908905029297 157.6549530029297,185.55996417999268 170.80321311950684,170.65610885620117 185.70706844329834,157.50784873962402 202.13799476623535,146.32630348205566 219.84810829162598,137.30664253234863 238.56754302978516,130.62944412231445 258.0009937286377,126.46493911743164 277.82158851623535,125.0 325.14727115631104,125.0 400.9158968925476,125.0 408.59214067459106,126.21583938598633 415.5169606208801,129.74419593811035 421.01253271102905,135.2397918701172 424.540913105011,142.16461181640625 425.75669288635254,149.84078407287598 425.75669288635254,150.1594066619873 424.540913105011,157.83557891845703 421.01253271102905,164.7603988647461 415.5169606208801,170.25599479675293 408.59214067459106,173.78435134887695 400.9158968925476,175.00019073486328 288.2838249206543,175.00019073486328 273.59607219696045,176.08575820922852 259.1952085494995,179.17180061340332 245.32346725463867,184.1198444366455 232.19964504241943,190.80371856689453 220.023775100708,199.0896224975586 208.97948741912842,208.8329553604126 199.2361545562744,219.8772430419922 190.95025062561035,232.0531129837036 184.26637649536133,245.17693519592285 179.31833267211914,259.0486764907837 176.23229026794434,273.44954013824463 175.1467227935791,288.1372928619385 175.1467227935791,401.35645866394043 173.93088340759277,409.032678604126 170.40252685546875,415.95749855041504 164.9069309234619,421.45307064056396 157.98211097717285,424.9814510345459 150.30593872070312,426.19725465774536 149.98788833618164,426.19725465774536 142.3117160797119,424.9814510345459 135.38689613342285,421.45307064056396 129.89130020141602,415.95749855041504 126.36294364929199,409.032678604126 125.14710426330566,401.35645866394043 ">
            </polygon>
            <rect id='test' fill-opacity='0' width='1152.9664516448975' height='1154.4738292694092' />
        </svg>
    </div>
</body>

</html>
<script src="/socket.io/socket.io.js"></script>
<script>

    const getNodeConfig = () => ({
        name: document.querySelector("#NNodeName").value, input: [...document.querySelectorAll(".ncreateIO")].filter(x => x.value == 1).map(x => ({ name: document.getElementById("NName" + x.id.slice(-1)).value, type: document.getElementById("NType" + x.id.slice(-1)).value, var: document.getElementById("NVar" + x.id.slice(-1)).value })),
        output: [...document.querySelectorAll(".ncreateIO")].filter(x => x.value == 2).map(x => ({ name: document.getElementById("NName" + x.id.slice(-1)).value, type: document.getElementById("NType" + x.id.slice(-1)).value, var: document.getElementById("NVar" + x.id.slice(-1)).value })),
        args: [...document.querySelectorAll(".ncreateIO")].filter(x => x.value == 3).map(x => ({ name: document.getElementById("NName" + x.id.slice(-1)).value, type: document.getElementById("NType" + x.id.slice(-1)).value, var: document.getElementById("NVar" + x.id.slice(-1)).value }))
    })


    document.getElementById("NodeSave").addEventListener("click", () => sendNewNodeConfig(getNodeConfig()))
    let cccounter = 0
    function htmlToElement(html) {
        var template = document.createElement('template');
        html = html.trim(); // Never return a text node of whitespace as the result
        template.innerHTML = html;
        return template.content.firstChild;
    }
    document.getElementById("addio").addEventListener("click", () => document.getElementById("io").append(htmlToElement(`<div class=" mb-3 nodes"><input type="text" id="NName` + cccounter + `" class="form-control" placeholder="Name" aria-label="name">


  <input type="text" class="form-control ncreateType" id="NType`+ cccounter + `" placeholder="Type" aria-label="type">
  <input type="text" class="form-control ncreateVar" id="NVar`+ cccounter + `" placeholder="Var Name" aria-label="varName">
  <select class="form-select ncreateIO"  id="IO`+ cccounter++ + `">
    <option value="1">Input</option>
    <option value="2">Output</option>
    <option value="3">Argument</option>
  </select>
</div>`)))


    document.getElementById("svg").setAttribute("height", window.innerHeight);
    document.getElementById("svg").setAttribute("width", window.innerWidth);

    var check = false; 1
    var counter = 0
    var socket = io();
    var config = {}
    var connections = []
    var picker = {}

    socket.on('setConfig', function (msg) {
        config = msg
        console.log(config)
        let ele = document.getElementById("add")
        ele.innerHTML = ""
        for (let c in config) {
            //pls improve me
            ele.innerHTML += "<button type='button' class='btn btn-outline-success ' id='add" + config[c].name + "'>" + config[c].name + "</button>"
        }
        for (let c in config) {
            document.getElementById("add" + config[c].name).addEventListener("click", () => {
                socket.emit("addNode", { name: c })
            })
        }
    });
    socket.on('ArgChange', function (msg) {
        let a = document.getElementById(msg.id).children[0].children
        for (let e of a) {
            if ((e.classList[1] === msg.ioid)) {
                msg.value = (msg.value === "true") ? true : msg.value
                msg.value = (msg.value === "false") ? false : msg.value
                if (typeof (msg.value) === 'boolean') {
                    e.checked = msg.value
                }
                else {
                    e.value = msg.value
                }
            }
        }
    });
    socket.on("NodePositionChange", function (msg) {
        console.log(msg)
        if (!check) {
            document.getElementById(msg.id).style.left = msg.x + "px"
            document.getElementById(msg.id).style.top = msg.y + "px"
        }
        renderConnections()
    });

    socket.on('connectNodes', function (msg) {
        connections = msg
        renderConnections()
    })
    socket.on("VSLink", (msg) => {
        console.log(msg)
        window.open(msg, "_blank")
    })
    socket.on('update', function (msg) {
        console.log(msg)
        document.getElementById("Nodes").innerHTML = ""

        for (let node of msg) {
            document.getElementById("Nodes").innerHTML += node.html

        }
        for (let node of msg) {
            makeDraggable(document.getElementById(node.id))
            addArgListener(document.getElementById(node.id))
            addStartListener(document.getElementById(node.id))
            addCloseListener(document.getElementById(node.id))
            nodeReSize(node.id)
            let io = document.getElementById(node.id).children[0].children[document.getElementById(node.id).children[0].children.length - 1].children
            console.log(io)

            for (let out of io) {
                if (out.children[1].children[0] !== undefined) {

                    makeConnectable(out.children[1].children[0].children[1].children[0])
                }
            }
        }

    });



    function addArgListener(ele) {

        let a = ele.children[0].children
        for (let e of a) {
            if (e.localName === "input") {

                e.addEventListener("change", () => {
                    console.log({ id: ele.id, ioid: e.classList[0], value: e.type === "checkbox" ? e.checked : e.value })
                    socket.emit("ArgChange", { id: ele.id, ioid: (e.type === "checkbox" ? e.classList[0] : e.classList[1]), value: (e.type === "checkbox" ? e.checked : e.value) })
                })

            }
            if (e.classList[1] === 'picker') {
                console.log(e)
                if (picker[e.id] !== undefined) {
                    console.log($("#" + e.id))


                }
                picker[e.id] = $("#" + e.id).colorpicker()
                setTimeout(function () {

                    console.log($("#" + e.id))
                    $("#" + e.id).on("change", function (b) {
                        let range = document.getElementById(e.classList[2])
                        let value = JSON.parse(range.value)

                        let out = b.color.toString().slice(4).slice(0, -1)
                        out = JSON.parse("[" + out + "]")
                        value[parseInt(e.classList[3])] = out
                        range.value = JSON.stringify(value)
                        socket.emit("ArgChange", { id: ele.id, ioid: range.classList[1], value: range.value })
                        console.log(out)
                    })
                }, 5)
            }

        }
    }

    function sendNewNodeConfig(config) {
        socket.emit("createNewNode", config)
    }

    function addStartListener(ele) {
        if (document.getElementById(ele.id + "start")) {
            document.getElementById(ele.id + "start").addEventListener("click", function () {
                socket.emit("startNode", { id: ele.id })
            })
        }
    }
    function addCloseListener(ele) {
        if (document.getElementById(ele.id + "del")) {
            document.getElementById(ele.id + "del").addEventListener("click", function () {
                socket.emit("removeNode", { node: ele.id })
            })
        }
    }
    function makeDraggable(ele) {


        ele._pos = { pos1: 0, pos2: 0, pos3: 0, pos4: 0 }
        ele.onmousedown = dragMouseDown;

        function dragMouseDown(e) {


            if (e.target.localName !== "input" && e.target.localName !== "circle" && e.target.localName !== "svg" && e.target.localName !== "button" && e.target.localName !== "delete") {
                e = e || window.event;
                e.preventDefault();
                ele._pos.pos3 = e.clientX;
                ele._pos.pos4 = e.clientY;
                document.onmouseup = closeDragElement;
                document.onmousemove = elementDrag;
                check = true
            }
        }
        function elementDrag(e) {
            e = e || window.event;
            e.preventDefault();

            ele._pos.pos1 = ele._pos.pos3 - e.clientX;
            ele._pos.pos2 = ele._pos.pos4 - e.clientY;
            ele._pos.pos3 = e.clientX;
            ele._pos.pos4 = e.clientY;


            ele.style.left = (ele.offsetLeft - ele._pos.pos1) + "px"
            ele.style.top = (ele.offsetTop - ele._pos.pos2) + "px"
            renderConnections()
            if (counter > 5) {
                socket.emit("NodePositionChange", {
                    id: ele.id,
                    x: (ele.offsetLeft - ele._pos.pos1),
                    y: (ele.offsetTop - ele._pos.pos2)
                })
                counter = 0
            }
            counter++;
        }

        function closeDragElement() {
            check = false
            socket.emit("NodePositionChange", { id: ele.id, x: (ele.offsetLeft - ele._pos.pos1), y: (ele.offsetTop - ele._pos.pos2) })

            document.onmouseup = null;
            document.onmousemove = null;
        }
    }

    function makeConnectable(ele) {
        ele._pos = { pos1: 0, pos2: 0, pos3: 0, pos4: 0 }
        ele.onmousedown = dragMouseDown;

        function preview(e) {


            ele._pos.pos3 = parseInt(e.clientX);
            ele._pos.pos4 = parseInt(e.clientY);
            let iny = ele._pos.pos4 ;

            let inx = ele._pos.pos3
            // let out = document.getElementById(node.id + "_" + node.output[outputName].name)

            let outRect = ele.getBoundingClientRect()
            let outx = outRect.x
            let outy = outRect.y + Math.floor(outRect.height / 2)


            let avgx = (inx + outx) / 2
            let avgy = (iny + outy) / 2
            renderConnections()
            document.getElementById("svg").innerHTML += "<path  d='M" + outx + " " + outy + " Q " + (avgx + outx) / 2 + " " + outy + ", " + avgx + " " + avgy + " T " + inx + " " + iny + "' stroke-width='1.5' stroke='white' fill='transparent'>" //' <path x1="' + inx + '" y1="' + iny + '" x2="' + outx + '" y2="' + outy + '" style="stroke: black;z-index: 5">'

        }
        function dragMouseDown(e) {
            console.log(e)

            e = e || window.event;
            ele._pos.pos3 = parseInt(e.clientX);
            ele._pos.pos4 = parseInt(e.clientY);





            document.onmouseup = closeDragElement;
            document.onmousemove = preview
            return false;



        }

        function closeDragElement(e) {
            if (e.target.classList.contains("in")) {
                let p = e.target
                if (e.target.id === "") {
                    p = e.target.parentElement
                }

                socket.emit("connectNodes", { output: ele.id, input: p.id })
                console.log({ output: ele, input: p })

            }

            document.onmouseup = null;
            document.onmousemove = null;
            renderConnections()
        }

    }
    function renderConnections(ele = "svg") {
        console.log(document.getElementById(ele))
        let svg = document.getElementById(ele)
        svg.innerHTML = ""
        for (let con of connections) {

            let out = document.getElementById(con.output+"out")
            let In = document.getElementById(con.input+"in")
            if (out !== null && In !== null) {
                let outRect = out.getBoundingClientRect()
                let outx = outRect.x
                let outy = outRect.y + Math.floor(outRect.height / 2)



                let inRect = In.getBoundingClientRect()
                let inx = inRect.x
                let iny = inRect.y + Math.floor(inRect.height / 2)
                let avgx = (inx + outx) / 2
                let avgy = (iny + outy) / 2


                svg.innerHTML += "<path id='con" + con.input + con.output + "' d='M" + outx + " " + outy + " Q " + (avgx + outx) / 2 + " " + outy + ", " + avgx + " " + avgy + " T " + inx + " " + iny + "'  stroke-width='1.5'  stroke='white' fill='transparent'>"
            }
        }
        setTimeout(() => {
            for (let con of connections) {
                if (document.getElementById("con" + con.input + con.output) !== null) {
                    document.getElementById("con" + con.input + con.output).addEventListener('contextmenu', function (ev) {
                        ev.preventDefault();
                        openRightMenu(ev, con)
                        return false;
                    }, false);
                }
            }
        }, 5
        )
    }

    function openRightMenu(ev, con) {



        document.getElementById("rightmenu").style.left = ev.clientX + "px"
        document.getElementById("rightmenu").style.top = ev.clientY + "px"
        document.getElementById("rightmenu").style.visibility = "visible"
        selectedCon = con

    }
    var selectedCon;
    document.getElementById("a").addEventListener("mousedown", function (e) {
        if (document.getElementById("rightmenu").style.visibility === "visible") {
            if (e.target.localName === "a") {
                socket.emit("removeConnection", { con: selectedCon })
            }
            document.getElementById("rightmenu").style.visibility = "hidden"
            // document.getElementById("rightmenu").remove()

        }



    })
    var id = null;
    function showAddMenu() {
        let ele = document.getElementById("addMenu")
        ele.style.bottom = -25 + '%';
        var pos = -25;
        clearInterval(id);
        id = setInterval(frame, 5);
        function frame() {
            if (pos == 0) {
                clearInterval(id);
            } else {
                pos += 0.5;
                ele.style.bottom = pos + '%';

            }
        }
    }
    function closeAddMenu() {
        let ele = document.getElementById("addMenu")
        ele.style.bottom = 0 + '%';
        var pos = 0;
        clearInterval(id);
        id = setInterval(frame, 5);
        function frame() {
            if (pos == -25) {
                clearInterval(id);
            } else {
                pos -= 0.5;
                ele.style.bottom = pos + '%';

            }
        }
    }

function nodeReSize(ele){
console.log(ele)
   document.getElementById(ele).querySelector(".container").style.height= Math.max(document.getElementById(ele).querySelectorAll(".input").length,document.getElementById(ele).querySelectorAll(".output").length)*24+"px"
}

</script>

<script>
    //generated using blender extension
    function hover() {
        SVG.find('.a0').animate().transform({ translate: [-100.0, 100.0] });
        SVG.find('.a1').animate().transform({ translate: [100.0, 100.0] });
        SVG.find('.a2').animate().transform({ translate: [0.0, 0.0] });
        SVG.find('.a3').animate().transform({ translate: [100.0, -100.0] });
        SVG.find('.a4').animate().transform({ translate: [-100.0, -100.0] });
    }; document.getElementById('buttonAdd').addEventListener('mouseover', hover); function endHover() {
        SVG.find('.a0').animate().transform({ translate: [0.0, 0.0] });
        SVG.find('.a1').animate().transform({ translate: [0.0, 0.0] });
        SVG.find('.a2').animate().transform({ translate: [0.0, 0.0] });
        SVG.find('.a3').animate().transform({ translate: [0.0, 0.0] });
        SVG.find('.a4').animate().transform({ translate: [0.0, 0.0] });
    }; document.getElementById('buttonAdd').addEventListener('mouseleave', endHover);</script>