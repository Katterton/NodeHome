<!DOCTYPE html>
<html lang="en">

<head><link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>
<link href="NodeStyle.css" rel="stylesheet">
    <meta charset="UTF-8">
    <title>Title</title>
</head>
<body id="a">
<div id="add"></div>
<div id = "Nodes"></div>
</body>
</html>
<script src="/socket.io/socket.io.js"></script>
<script>
    var check=false;1
    var counter = 0
    var socket = io();
    var config = {}

    socket.on('setConfig', function(msg) {
       config=msg
        console.log(config)
        let ele = document.getElementById("add")
        ele.innerHTML=""
        for (let c in config){
            //pls improve me
            ele.innerHTML+="<button id='add"+config[c].name+"'>Add "+config[c].name+"</button>"
        }
        for (let c in config){
            document.getElementById("add"+config[c].name).addEventListener("click",()=>{
                socket.emit("addNode",{name:c})
            })
        }
    });
    socket.on('ArgChange', function(msg) {
        let a =document.getElementById(msg.id).children[0].children
        for(let e of a){
            if((e.classList[1]===msg.ioid)){
                e.value=msg.value
            }
        }
    });
    socket.on("NodePositionChange", function(msg) {
        console.log(msg)
        if(!check) {
            document.getElementById(msg.id).style.left = msg.x + "px"
            document.getElementById(msg.id).style.top = msg.y + "px"
        }
    });
    socket.on('update', function(msg) {
        console.log(msg)
        document.getElementById("Nodes").innerHTML = ""

        for(let node of msg) {
            document.getElementById("Nodes").innerHTML +=node.html

        }
        for(let node of msg) {
             makeDraggable(document.getElementById(node.id))
            addArgListener(document.getElementById(node.id))
        }
    });



    function addArgListener(ele){

let a = ele.children[0].children
        for(let e of a){
            if(e.localName==="input"){
                e.addEventListener("change",()=>{
                    console.log({id:ele.id, ioid:e.classList[1], value:e.value})
                    socket.emit("ArgChange",{id:ele.id, ioid:e.classList[1], value:e.value})
                })
            }
        }
    }

    function makeDraggable(ele){


        ele._pos={pos1:0, pos2:0, pos3:0,pos4:0}
            ele.onmousedown = dragMouseDown;

            function dragMouseDown(e) {


                if(e.target.localName!=="input") {
                    e = e || window.event;
                e.preventDefault();
                ele._pos.pos3 =e.clientX;
                ele._pos.pos4 =e.clientY;
                    document.onmouseup = closeDragElement;
                    document.onmousemove = elementDrag;
check=true
              }
            }
        function elementDrag(e) {
            e = e || window.event;
            e.preventDefault();

            ele._pos.pos1 = ele._pos.pos3 - e.clientX;
            ele._pos.pos2 = ele._pos.pos4 - e.clientY;
            ele._pos.pos3 = e.clientX;
            ele._pos.pos4 = e.clientY;


           ele.style.left =(ele.offsetLeft - ele._pos.pos1)+"px"
            ele.style.top =(ele.offsetTop - ele._pos.pos2)+"px"
           if(counter>5) {
               socket.emit("NodePositionChange", {
                   id: ele.id,
                   x: (ele.offsetLeft - ele._pos.pos1),
                   y: (ele.offsetTop - ele._pos.pos2)
               })
               counter=0
           }
           counter++;
           }

        function closeDragElement() {
            check=false
            socket.emit("NodePositionChange",{id:ele.id, x:(ele.offsetLeft - ele._pos.pos1),y:(ele.offsetTop - ele._pos.pos2)})

            document.onmouseup = null;
            document.onmousemove = null;
        }
    }







    </script>